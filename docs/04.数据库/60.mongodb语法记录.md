---
title: mongodb语法记录
date: 2023-11-12 16:05:07
permalink: /pages/234c52/
categories:
  - 数据库
tags:
  - mongodb
author: 
  name: Mr.Kusch
  link: https://github.com/kuschzzp
---

## 一、MongoDB 查询语言 (MQL) 的核心思想

MongoDB 不像 SQL 用 `SELECT ... FROM ... WHERE ...`，
它是一种 **JSON 风格的查询语言** —— 用文档（对象）描述查询条件。

比如你在 SQL 里写：

```sql
SELECT * FROM users WHERE age > 18 AND city = 'Shanghai';
```

在 MongoDB 是：

```js
db.users.find({ age: { $gt: 18 }, city: "Shanghai" })
```

> `db.<集合名>.find(查询条件)`

---

## 二、常见查询语法

| 操作符    | 含义    | 示例                                           |
| ------ | ----- | -------------------------------------------- |
| `$eq`  | 等于    | `{ age: { $eq: 18 } }`                       |
| `$ne`  | 不等于   | `{ age: { $ne: 18 } }`                       |
| `$gt`  | 大于    | `{ age: { $gt: 18 } }`                       |
| `$gte` | 大于等于  | `{ age: { $gte: 18 } }`                      |
| `$lt`  | 小于    | `{ age: { $lt: 30 } }`                       |
| `$lte` | 小于等于  | `{ age: { $lte: 30 } }`                      |
| `$in`  | 在集合中  | `{ city: { $in: ["Beijing", "Shanghai"] } }` |
| `$nin` | 不在集合中 | `{ city: { $nin: ["Beijing"] } }`            |

### 示例：

```js
db.users.find({ age: { $gte: 18, $lt: 30 }, gender: "male" })
```

表示：

> 查找年龄在 18 到 30 岁之间、性别为男的用户。

---

## 三、字段筛选（只返回需要的字段）

```js
db.users.find(
  { city: "Shanghai" },
  { name: 1, age: 1, _id: 0 }
)
```

> 第二个对象 `{ name:1, age:1 }` 表示只返回这些字段。

---

## 四、模糊匹配（正则）

```js
db.users.find({ name: { $regex: "zhang", $options: "i" } })
```

> 相当于 SQL 的 `LIKE '%zhang%'`，`i` 表示忽略大小写。

---

## 五、分页与排序

```js
db.users.find().sort({ age: -1 }).skip(10).limit(5)
```

> 年龄倒序排序，跳过前10条，只取5条。

---

## 六、聚合（aggregate）入门

聚合（Aggregation）是 MongoDB 的“高级统计引擎”，
你可以理解为 SQL 的 `GROUP BY` + `JOIN` + `HAVING`。

语法：

```js
db.collection.aggregate([
  { $match: {...} },     // 过滤
  { $group: {...} },     // 分组
  { $project: {...} },   // 投影
  { $sort: {...} },      // 排序
  { $limit: n }          // 限制数量
])
```

### `$group` + `$project` 示例

####  `$group` 语法

```text
{
  $group: {
    _id: <分组字段>,
    <输出字段>: { <聚合运算符>: <表达式> },
    ...
  }
}
```

相当于 SQL 的 GROUP BY

| 部分        | 说明                                  |
| --------- | ----------------------------------- |
| `_id`     | 要按哪个字段分组（可以是一个字段，也可以是复合键）           |
| `<输出字段>`  | 统计结果的名字                             |
| `<聚合运算符>` | 统计逻辑，比如 `$sum`、`$avg`、`$max`、`$min` |


- 示例：统计每个城市有多少个用户
```js
db.users.aggregate([
  { $group: { _id: "$city", count: { $sum: 1 } } }
])
```
结果
```js
[
  { "_id": "上海", "count": 12 },
  { "_id": "北京", "count": 8 }
]
```
`$sum: 1` 的意思是“每出现一条记录，就加1”。

- 示例： 按多个字段分组
```js
db.users.aggregate([
  {
    $group: {
      _id: { city: "$city", gender: "$gender" },
      count: { $sum: 1 }
    }
  }
])
```
结果
```js
[
    { "_id": { "city": "上海", "gender": "男" }, "count": 6 },
    { "_id": { "city": "上海", "gender": "女" }, "count": 6 },
    { "_id": { "city": "北京", "gender": "男" }, "count": 5 },
    { "_id": { "city": "北京", "gender": "女" }, "count": 3 }
]
````

常用操作符：

| 操作符                | 含义               | 示例                          |
| ------------------ | ---------------- | --------------------------- |
| `$sum`             | 求和 / 计数          | `{ $sum: "$salary" }`       |
| `$avg`             | 平均值              | `{ $avg: "$age" }`          |
| `$max`             | 最大值              | `{ $max: "$age" }`          |
| `$min`             | 最小值              | `{ $min: "$age" }`          |
| `$push`            | 把分组内的值放到数组里      | `{ $push: "$name" }`        |
| `$addToSet`        | 类似 `$push`，但自动去重 | `{ $addToSet: "$city" }`    |
| `$first` / `$last` | 取第一/最后一条的值       | `{ $first: "$created_at" }` |

####  `$project` 语法

常见作用
- 选择哪些字段要输出；
- 修改字段名；
- 创建新的计算字段；
- 删除 _id 字段。

```js
{
  $project: {
    <字段名>: 1 或 0,
    <新字段名>: <表达式>
  }
}

```
- 示例：只保留 name、city

```js
db.users.aggregate([
  { $project: { name: 1, city: 1, _id: 0 } }
])
```

- 示例：创建新字段（年龄+5）

```js
db.users.aggregate([
    { $project: { name: 1, newAge: { $add: ["$age", 5] } } }
])
```
> `$add` 表示数值相加。


- 组合示例：展开 $group 的 _id 字段

```js
db.users.aggregate([
  { $group: { _id: "$city", count: { $sum: 1 } } },
  { $project: { _id: 0, city: "$_id", count: 1 } }
])
```
结果：
```js
[
  { "city": "上海", "count": 12 },
  { "city": "北京", "count": 8 }
]
```
> 因为 `$group` 把分组字段都放进了 `_id`，所以我们用 `$project` 再把它“展开”成顶层字段。

- 再来一个例子：统计每个城市中男女平均年龄，并只显示城市、性别、平均年龄：

```js
db.users.aggregate([
  { $group: {
      _id: { city: "$city", gender: "$gender" },
      avgAge: { $avg: "$age" }
  }},
  { $project: {
      _id: 0,
      city: "$_id.city",
      gender: "$_id.gender",
      avgAge: 1
  }}
])
```

结果：

```js
[
  { "city": "上海", "gender": "男", "avgAge": 29.1 },
  { "city": "上海", "gender": "女", "avgAge": 27.8 },
  { "city": "北京", "gender": "男", "avgAge": 32.0 },
  { "city": "北京", "gender": "女", "avgAge": 30.5 }
]
```

## 常用聚合操作符表

| 操作符                | 功能                 | 示例                                                                                       |
| ------------------ | ------------------ | ---------------------------------------------------------------------------------------- |
| `$match`           | 过滤数据（类似 SQL WHERE） | `{ $match: { age: { $gte: 18 } } }`                                                      |
| `$group`           | 分组统计               | `{ $group: { _id: "$city", count: { $sum: 1 } } }`                                       |
| `$project`         | 字段选择或新字段计算         | `{ $project: { name: 1, year: { $year: "$birthday" } } }`                                |
| `$sort`            | 排序                 | `{ $sort: { count: -1 } }`                                                               |
| `$limit` / `$skip` | 分页                 | `{ $limit: 10 }`                                                                         |
| `$lookup`          | 表关联（相当于 SQL JOIN）  | `{ $lookup: { from: "device", localField: "pid", foreignField: "pid", as: "devices" } }` |
| `$unwind`          | 拆数组为多行             | `{ $unwind: "$tags" }`                                                                   |
| `$addFields`       | 增加新字段              | `{ $addFields: { total: { $sum: ["$a", "$b"] } } }`                                      |
| `$count`           | 统计总数量              | `{ $count: "total" }`                                                                    |

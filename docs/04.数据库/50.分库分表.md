---
title: 分库分表
date: 2023-08-23 15:08:11
permalink: /pages/ee064d/
categories:
  - 数据库
tags:
  - 分库分表
author: 
  name: Mr.Kusch
  link: https://github.com/kuschzzp
---

## 分库分表

### 概念

在系统数据量和并发量不断增长的情况下，单库单表往往会成为性能瓶颈。
为了提升性能与可扩展性，可以根据业务需求采用 **分库分表** 的设计思路。
常见的方式有：

* **垂直分表（Vertical Table Split）**
* **水平分表（Horizontal Table Split）**
* **垂直分库（Vertical Database Split）**
* **水平分库（Horizontal Database Split）**


### 垂直分表

**定义：**
将一张表中访问频率、字段类型或数据用途差异较大的字段拆分到不同的表中，以减少单表字段数量，提高访问效率。

**举例：**
假设存在一张表 `table1`，包含字段 `A、B、C、D、E`。
其中字段 `A、B、C` 访问频率高，而 `D、E` 较少使用。
可以将表拆分为：

* 表 `table1_main (A,B,C)`
* 表 `table1_detail (D,E)`

两张表通过主键 `id` 关联，查询时按需 JOIN。

**优点：**

* 降低 I/O 消耗，提高常用字段查询性能；
* 减少表宽度，提高缓存命中率；
* 提升维护性，不常用字段可单独扩展。

**缺点：**

* 查询多表 JOIN 时，复杂度上升；
* 写入操作需要维护多张表的一致性。

**适用场景：**

* 表字段多且访问频率差异明显；
* 部分大字段（如 text、blob）可单独存储；
* 对性能要求高的 OLTP 系统。



### 水平分表

**定义：**
当单表数据量过大时（例如千万级以上），可以根据时间、范围、Hash 等规则将数据拆分到多张结构相同的表中。

**举例：**
在垂直分表后的 `table1_main` 中，数据量逐渐增大，可按月分表：

* `table1_main_202308`
* `table1_main_202309`
* `table1_main_202310`

**优点：**

* 单表数据量减少，查询效率显著提升；
* 分布式并行查询能力增强；
* 易于冷热数据分离（老表归档，热表读写）。

**缺点：**

* 跨表查询复杂，分页统计需合并多表；
* 动态建表与路由策略管理复杂；
* 无法依赖单表自增 ID。

**常见分片策略：**

| 分片方式      | 说明        | 示例                |
| --------- | --------- | ----------------- |
| 按时间分表     | 按月/按天     | `table_202311`    |
| 按范围分表     | 按用户 ID 区间 | `user_0_9999`     |
| 按 Hash 分表 | 对主键取模     | `table_${id % 8}` |

**适用场景：**

* 日志表、订单表、交易记录表；
* 业务天然存在时间维度或用户维度分片逻辑。



### 垂直分库

**定义：**
将不同业务模块的数据放到不同数据库中。
例如一个系统中有用户模块、订单模块、库存模块，就可以分别放在 `user_db`、`order_db`、`stock_db`。

**优点：**

* 各数据库负载分摊，读写性能提升；
* 不同业务模块可独立维护、扩展；
* 单数据库结构更清晰。

**缺点：**

* 跨库事务处理复杂；
* 分库间 JOIN 不再可用，需要通过接口或中间层聚合；
* 数据一致性维护难度上升。

**适用场景：**

* 系统功能模块清晰、业务耦合度低；
* 不同业务数据量差异明显；
* 希望模块独立扩展、独立维护。



### 水平分库

**定义：**
当单库连接数、写入量或磁盘 I/O 达到瓶颈时，可将同一张表拆分到多个数据库中，每个库保存部分数据。

**举例：**
假设 `user` 表数据量巨大，可以将其按用户 ID 分散存储：

* 用户ID % 2 = 0 → 存在 `user_db_0.user`
* 用户ID % 2 = 1 → 存在 `user_db_1.user`

**优点：**

* 彻底缓解单数据库瓶颈；
* 提升系统整体并发处理能力；
* 可灵活扩容（添加新库）。

**缺点：**

* 跨库事务需依赖分布式事务框架（如 Seata）；
* 查询需要跨库聚合；
* 数据迁移与扩容相对复杂。

**适用场景：**

* 超大规模用户表、订单表；
* 分布式架构中存在数据库性能瓶颈；
* 读写高并发、数据分区天然独立的系统。



### 分库分表中间件与路由策略

为降低开发复杂度，一般会使用中间件来管理路由与分片逻辑。常见方案：

| 中间件                | 特点                 | 适用场景             |
| ------------------ | ------------------ | ---------------- |
|  ShardingSphere  | 支持分库分表、读写分离、分布式事务  | 主流方案，兼容 JDBC     |
|  MyCat           | 基于代理层的分库分表中间件      | 老牌方案，SQL 解析层实现路由 |
|  TDDL（阿里）        | 高性能分布式数据库访问层       | 内部项目或大中型系统       |
|  自研路由层           | 通过 Hash、时间规则自行维护分表 | 轻量场景、简单分表逻辑      |

**ShardingSphere 配置示例：**

```yaml
spring:
  shardingsphere:
    datasource:
      names: ds0,ds1
      ds0:
        url: jdbc:mysql://localhost:3306/user_db_0
      ds1:
        url: jdbc:mysql://localhost:3306/user_db_1
    sharding:
      tables:
        user:
          actual-data-nodes: ds$->{0..1}.user_$->{0..3}
          table-strategy:
            inline:
              sharding-column: id
              algorithm-expression: user_$->{id % 4}
```

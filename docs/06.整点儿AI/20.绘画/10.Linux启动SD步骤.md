---
title: Linux启动SD步骤
date: 2024-12-12 13:45:35
permalink: /pages/23d76e/
categories:
  - 整点儿AI
  - 绘画
tags:
  - SD
author:
  name: Mr.Kusch
  link: https://github.com/kuschzzp
---

## Linux 启动SD

### 一、准备工作

#### 安装Miniconda

1. 下载Miniconda安装包
   ```shell
   wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
   ```
2. 安装Miniconda
   ```shell
    sh Miniconda3-latest-Linux-x86_64.sh
    ```
3. 查看版本
   ```shell
   conda --version
   ```
4. 创建SD要用的虚拟环境
    ```shell
   conda create --name stabledifussionwebui python=3.10
    ```
5. 激活虚拟环境
    ```shell
    conda activate stabledifussionwebui
     ```
6. 删除虚拟环境
    ```shell
    conda remove --name stabledifussionwebui --all
    ```

> 以下内容可选，如果网络不好，可以设置清华源，不过不建议设置，可能会出问题。

- 设置pip源为清华源
    ```shell
    pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
    ```
- 查看设置的镜像源
    ```shell
    pip config list
    ```
- 附加输出配置文件路径
    ```shell
    pip config list -v 
    ```

#### 安装Git

1. 安装Git
   ```shell
   yum install git -y
   ```
2. 查看版本
   ```shell
    git --version
    ```

> 以下内容可选

- 配置代理（可选，也可以在 clone 连接前拼上代理地址）
   ```shell
   git config --global url."https://gitclone.com/".insteadOf https://
   ```
- 还原
    ```shell
    git config --global --unset url."https://gitclone.com/".insteadOf
    ```

### 拉取github代码

1. 拉取代码（没配置GIT代理就直接在URL前拼上上面的代理地址）
   ```shell
   git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git
   ```
2. 进入项目目录
   ```shell
    cd stable-diffusion-webui
    ```
3. 设置Huggingface镜像
   ```shell
   export HF_ENDPOINT=https://hf-mirror.com
   ```
   也可以写入环境变量
    ```shell
    echo "export HF_ENDPOINT=https://hf-mirror.com" >> ~/.bashrc
    ```
   让环境变量生效
    ```shell
    source ~/.bashrc
    ```
4. 启动项目
   ```shell
    ./webui.sh -f --share --listen --enable-insecure-extension-access --update-all-extensions --loglevel debug
    ```
   > `nvidia-smi`查看显卡，有多张可以使用 `--device-id` 参数指定GPU设备，例如 `--device-id 1`  
   > `--update-all-extensions` 更新所有插件
   后台启动
    ```shell
    nohup ./webui.sh -f --share --listen --enable-insecure-extension-access > /root/webuilogs/log_file.log 2>&1 &
    ```

### 关于下载模型

见这里：[https://hf-mirror.com/](https://hf-mirror.com/)

- 安装所需的包
    ```shell
    sudo yum install aria2 -y
    yum install git-lfs -y
    ```

例如你要下载：`https://huggingface.co/digiplay/majicMIX_realistic_v7/resolve/main/majicmixRealistic_v7.safetensors`  
把其中的`https://huggingface.co/`替换为`https://hf-mirror.com/`，然后用`aria2c`下载即可。

```shell
# 列举三个我常用的模型，下载到的是 ～/stable-diffusion-webui/models/Stable-diffusion 文件夹下
aria2c --console-log-level=warn --summary-interval=20 -c -x 16 -s 16 -k 1M https://hf-mirror.com/digiplay/majicMIX_realistic_v7/resolve/main/majicmixRealistic_v7.safetensors
aria2c --console-log-level=warn --summary-interval=20 -c -x 16 -s 16 -k 1M https://hf-mirror.com/naonovn/chilloutmix_NiPrunedFp32Fix/resolve/main/chilloutmix_NiPrunedFp32Fix.safetensors
aria2c --console-log-level=warn --summary-interval=20 -c -x 16 -s 16 -k 1M https://hf-mirror.com/xiaolxl/GuoFeng4_XL/resolve/main/Guofeng4.2XL.safetensors
```

### 下载模型脚本示例
    
```shell
#!/bin/sh

# sd-webui 代码你放在什么文件夹下

BASE_DIR="/opt/drawImages"

# SD 大模型路径
MODELS_FLODER="${BASE_DIR}/stable-diffusion-webui/models/Stable-diffusion"
if [ ! -d ${MODELS_FLODER} ]; then
  mkdir -p ${MODELS_FLODER}
fi
# SD contorlnet 模型路径
CONTROLNET_FLODER="${BASE_DIR}/stable-diffusion-webui/models/ControlNet"
if [ ! -d ${CONTROLNET_FLODER} ]; then
  mkdir -p ${CONTROLNET_FLODER}
fi

# ESRGAN 模型路径
ESRGAN_FLODER="${BASE_DIR}/stable-diffusion-webui/models/ESRGAN"
if [ ! -d ${ESRGAN_FLODER} ]; then
  mkdir -p ${ESRGAN_FLODER}
fi

# VAE 模型路径
VAE_FLODER="${BASE_DIR}/stable-diffusion-webui/models/VAE"
if [ ! -d ${VAE_FLODER} ]; then
  mkdir -p ${VAE_FLODER}
fi

# lora 模型路径
LORA_FLODER="${BASE_DIR}/stable-diffusion-webui/models/Lora"
if [ ! -d ${LORA_FLODER} ]; then
  mkdir -p ${LORA_FLODER}
fi


aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/digiplay/majicMIX_realistic_v7/resolve/main/majicmixRealistic_v7.safetensors -d ${MODELS_FLODER} -o majicmixRealistic_v7.safetensors
aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/naonovn/chilloutmix_NiPrunedFp32Fix/resolve/main/chilloutmix_NiPrunedFp32Fix.safetensors -d ${MODELS_FLODER} -o chilloutmix_NiPrunedFp32Fix.safetensors
aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/xiaolxl/GuoFeng4_XL/resolve/main/Guofeng4.2XL.safetensors -d ${MODELS_FLODER} -o Guofeng4.2XL.safetensors
aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/black-forest-labs/FLUX.1-dev/blob/main/flux1-dev.safetensors -d ${MODELS_FLODER} -o flux1-dev.safetensors


aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/comfyanonymous/ControlNet-v1-1_fp16_safetensors/resolve/main/control_v11e_sd15_ip2p_fp16.safetensors -d ${CONTROLNET_FLODER} -o control_v11e_sd15_ip2p.safetensors
aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/comfyanonymous/ControlNet-v1-1_fp16_safetensors/resolve/main/control_v11f1p_sd15_depth_fp16.safetensors -d ${CONTROLNET_FLODER} -o control_v11f1p_sd15_depth.safetensors
aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/comfyanonymous/ControlNet-v1-1_fp16_safetensors/resolve/main/control_v11p_sd15_canny_fp16.safetensors -d ${CONTROLNET_FLODER} -o control_v11p_sd15_canny.safetensors
aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/comfyanonymous/ControlNet-v1-1_fp16_safetensors/resolve/main/control_v11p_sd15_inpaint_fp16.safetensors -d ${CONTROLNET_FLODER} -o control_v11p_sd15_inpaint.safetensors
aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/comfyanonymous/ControlNet-v1-1_fp16_safetensors/resolve/main/control_v11p_sd15_lineart_fp16.safetensors -d ${CONTROLNET_FLODER} -o control_v11f1p_sd15_depth.safetensors
aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/comfyanonymous/ControlNet-v1-1_fp16_safetensors/resolve/main/control_v11p_sd15_mlsd_fp16.safetensors -d ${CONTROLNET_FLODER} -o control_v11p_sd15_mlsd.safetensors
aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/comfyanonymous/ControlNet-v1-1_fp16_safetensors/resolve/main/control_v11p_sd15_normalbae_fp16.safetensors -d ${CONTROLNET_FLODER} -o control_v11p_sd15_normalbae.safetensors
aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/comfyanonymous/ControlNet-v1-1_fp16_safetensors/resolve/main/control_v11p_sd15_openpose_fp16.safetensors -d ${CONTROLNET_FLODER} -o control_v11p_sd15_openpose.safetensors
aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/comfyanonymous/ControlNet-v1-1_fp16_safetensors/resolve/main/control_v11p_sd15_scribble_fp16.safetensors -d ${CONTROLNET_FLODER} -o control_v11p_sd15_scribble.safetensors
aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/comfyanonymous/ControlNet-v1-1_fp16_safetensors/resolve/main/control_v11p_sd15_seg_fp16.safetensors -d ${CONTROLNET_FLODER} -o control_v11p_sd15_seg.safetensors
aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/comfyanonymous/ControlNet-v1-1_fp16_safetensors/resolve/main/control_v11p_sd15_softedge_fp16.safetensors -d ${CONTROLNET_FLODER} -o control_v11p_sd15_softedge.safetensors
aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/comfyanonymous/ControlNet-v1-1_fp16_safetensors/resolve/main/control_v11p_sd15s2_lineart_anime_fp16.safetensors -d ${CONTROLNET_FLODER} -o control_v11p_sd15s2_lineart_anime.safetensors
aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/comfyanonymous/ControlNet-v1-1_fp16_safetensors/resolve/main/control_v11f1e_sd15_tile_fp16.safetensors -d ${CONTROLNET_FLODER} -o control_v11f1e_sd15_tile_fp16.safetensors


aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/lokCX/4x-Ultrasharp/resolve/main/4x-UltraSharp.pth -d ${ESRGAN_FLODER} -o 4x-UltraSharp.pth


aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/stabilityai/sd-vae-ft-mse-original/resolve/main/vae-ft-mse-840000-ema-pruned.safetensors -d ${VAE_FLODER} -o vae-ft-mse-840000-ema-pruned.safetensors
aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/hakurei/waifu-diffusion-v1-4/resolve/4c4f05104055c029ad577c18ac176462f0d1d7c1/vae/kl-f8-anime2.ckpt -d ${VAE_FLODER} -o kl-f8-anime2.ckpt
aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/swl-models/animvae/resolve/main/animevae.pt -d ${VAE_FLODER} -o animevae.pt


aria2c --console-log-level=warn --summary-interval=30 -c -x 16 -s 16 -k 1M https://hf-mirror.com/modelzpalace/AsiangirlsfaceV2/resolve/main/Asian%20girls%20faceV2.safetensors?download=true -d ${LORA_FLODER} -o asianGirlsFace_v1.safetensors

```


### 附：问题排查

#### 1. ERROR: This script must not be launched as root, aborting...

使用如下命令启动

```shell
bash webui.sh -f
```

#### 2. stderr: ERROR: Could not find a version that satisfies the requirement ftfy (from clip) (from versions: none)

使用如下命令安装缺失的东西：

```shell
conda install -c conda-forge ftfy
```

#### 3. RuntimeError: Couldn't checkout commit 48211a1594f1321b00f14c9f7a5b4813144b2fb9 for BLIP.

> 删除repositories/BLIP文件夹，实在不行就重新拉取代码。

#### 4. ImportError: libX11.so.6: cannot open shared object file: No such file or directory

```shell
sudo yum update
sudo yum install libX11
sudo yum install libXext libSM libXrender
```

#### 5. HTTPSConnectionPool(host='files.pythonhosted.org', port=443): Read timed out.

这是：cryptography安装失败，可以使用以下命令安装：

```shell
/opt/drawImages/stable-diffusion-webui/venv/bin/python3 -m pip install cryptography -i https://mirrors.aliyun.com/pypi/simple --prefer-binary
```
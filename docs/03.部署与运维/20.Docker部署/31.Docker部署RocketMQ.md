---
title: Docker部署RocketMQ
date: 2023-08-28 17:00:47
permalink: /pages/78c482/
categories:
  - 部署与运维
  - Docker部署
tags:
  - RocketMQ
author: 
  name: Mr.Kusch
  link: https://github.com/kuschzzp
---
## Docker部署RocketMQ


### 拉取镜像

1. 拉镜像

```shell
docker pull apache/rocketmq:5.3.2
```

2. 创建network
```shell
docker network create rocketmq
```

### 创建Name Server服务

#### 挂载卷创建
```shell
mkdir -p /data/rocketmq/nameserver/{bin,logs}
chmod 777 /data/rocketmq/nameserver/*
```

#### copy脚本

```shell
docker run -d --name rmqnamesrv apache/rocketmq:5.3.2 sh mqnamesrv
docker cp rmqnamesrv:/home/rocketmq/rocketmq-5.3.2/bin/runserver.sh /data/rocketmq/nameserver/bin/
docker rm -f rmqnamesrv
```

#### 构建容器 
```shell

docker run -d --network rocketmq \
--privileged=true --restart=unless-stopped \
--name rmqnamesrv -p 9876:9876 \
-v /data/rocketmq/nameserver/logs:/home/rocketmq/logs \
-v /data/rocketmq/nameserver/bin/runserver.sh:/home/rocketmq/rocketmq-5.3.2/bin/runserver.sh \
-e "MAX_POSSIBLE_HEAP=100000000" \
-e "JAVA_OPT_EXT=-Xms512M -Xmx512M -Xmn128m" \
apache/rocketmq:5.3.2 sh mqnamesrv
```

> - 看看是否启动成功  `docker logs -f rmqnamesrv`

### 部署 Broker + Proxy

#### 挂载卷、配置文件创建

创建一些文件夹：

```shell
mkdir -p /data/rocketmq/broker/{logs,store}
chmod 777 /data/rocketmq/broker/logs
chmod 777 /data/rocketmq/broker/store
```

```shell
mkdir -p /data/rocketmq/broker/conf && \
tee /data/rocketmq/broker/conf/broker.conf <<-'EOF'
# NameServer 地址
namesrvAddr=rmqnamesrv:9876
 
# 集群 & Broker 信息
brokerClusterName=DefaultCluster
brokerName=broker-a
brokerId=0
 
# Broker 对外 IP
brokerIP1=这里是对外的IP--------------------------------------------------------
 
# Broker 角色 + 刷盘方式
brokerRole=ASYNC_MASTER
flushDiskType=ASYNC_FLUSH
 
# 消息存储路径（容器内）
storePathRootDir=/home/rocketmq/store
storePathCommitLog=/home/rocketmq/store/commitlog
storePathConsumeQueue=/home/rocketmq/store/consumequeue
storePathIndex=/home/rocketmq/store/index
 
deleteWhen=04
fileReservedTime=72
diskMaxUsedSpaceRatio=75
 
autoCreateTopicEnable=true
autoCreateSubscriptionGroup=true
tlsTestModeEnable=false
EOF
```

#### copy脚本

```shell
mkdir -p /data/rocketmq/broker/bin/
docker run -d --name rmqbroker apache/rocketmq:5.3.2 sh mqbroker
docker cp rmqbroker:/home/rocketmq/rocketmq-5.3.2/bin/runbroker.sh /data/rocketmq/broker/bin/runbroker.sh
docker rm -f rmqbroker
```

#### 构建容器
```shell
docker run -d --network rocketmq \
--restart=unless-stopped --name rmqbroker --privileged=true \
-p 10911:10911 -p 10909:10909 -p 10912:10912 \
-p 8090:8080 -p 8091:8081 \
-v /data/rocketmq/broker/logs:/home/rocketmq/logs \
-v /data/rocketmq/broker/store:/home/rocketmq/store \
-v /data/rocketmq/broker/conf/broker.conf:/home/rocketmq/broker.conf \
-v /data/rocketmq/broker/bin/runbroker.sh:/home/rocketmq/rocketmq-5.3.2/bin/runbroker.sh \
-e "NAMESRV_ADDR=rmqnamesrv:9876" \
-e "JAVA_OPT_EXT=-Xms512M -Xmx512M -Xmn128m" \
-e "MAX_POSSIBLE_HEAP=200000000" \
apache/rocketmq:5.3.2 sh mqbroker --enable-proxy -c /home/rocketmq/broker.conf
```

> - 启动成功查看日志 `docker logs -f rmqbroker`

| 端口号 | 协议 | 用途说明 |
|--------|------|----------|
| 10911 | TCP | Broker 主通信端口（默认）。这是 Broker 与 Producer、Consumer 进行消息发送、拉取、心跳等核心通信的主要端口，客户端通过此端口连接到 Broker。 |
| 10909 | TCP | Broker HA（主从复制）端口（默认）。在主从架构中，Master Broker 使用此端口向 Slave Broker 推送数据，实现数据同步和高可用，Slave 会连接到 Master 的这个端口。 |
| 10912 | TCP | Broker 数据存储检查点端口（默认）。用于 Broker 内部组件之间传递存储检查点信息，支持主从同步和故障恢复，通常与 HA 配合使用。 |
| 8090  | TCP | Broker Dashboard / 控制台端口（自定义）。通过 `-p 8090:8080` 映射访问 RocketMQ Dashboard。 |
| 8091  | TCP | Broker Proxy 模式 Dashboard 端口（自定义）。在启动命令中使用了 `--enable-proxy` 参数会启动 RocketMQ Proxy 组件，Proxy 的 Dashboard 默认运行在 8081 端口，通过 `-p 8091:8081` 映射到宿主机用于访问 Proxy 管理界面。 |

### 创建可视化页面服务

- 不带账号密码

```shell
docker run -d \
--restart=unless-stopped --name rmq-dashboard \
-p 8092:8082 --network rocketmq \
-e "JAVA_OPTS=-Xmx256M -Xms256M -Xmn128M -Drocketmq.namesrv.addr=rmqnamesrv:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false" \
apacherocketmq/rocketmq-dashboard
```


- 带账号密码

创建配置文件：
```shell
mkdir -p /data/rocketmq-dashboard/tmp/rocketmq-console/data && \
tee /data/rocketmq-dashboard/tmp/rocketmq-console/data/users.properties <<-'EOF'
# This file supports hot change, any change will be auto-reloaded without Dashboard restarting.
# Format: a user per line, username=password[,N] #N is optional, 0 (Normal User); 1 (Admin)
# Define Admin
admin=Admin@Password,1
# Define Users
user1=user
user2=user
EOF
```


```shell
docker run -d \
  --restart=unless-stopped \
  --name rmq-dashboard \
  -p 8092:8082 \
  --network rocketmq \
  -v /data/rocketmq-dashboard/tmp/rocketmq-console/data/users.properties:/opt/rocketmq-console/data/users.properties \
  -e "JAVA_OPTS=-Xmx256M -Xms256M -Xmn128M -Drocketmq.namesrv.addr=rmqnamesrv:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false -Drocketmq.config.loginRequired=true" \
  docker.1ms.run/apacherocketmq/rocketmq-dashboard
```

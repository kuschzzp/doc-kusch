---
title: Docker部署MongoDB
date: 2023-10-30 16:47:50
permalink: /pages/2da055/
categories:
  - 部署与运维
  - Docker部署
tags:
  - mongodb
author: 
  name: Mr.Kusch
  link: https://github.com/kuschzzp
---


## Docker部署MongoDB

### 拉取镜像

```shell
docker pull mongo:8.0.15
```

### 启动镜像

```shell
docker run -itd \
--name mongodb \
-p 9701:27017 \
-e MONGO_INITDB_ROOT_USERNAME=root \
-e MONGO_INITDB_ROOT_PASSWORD=RootPass_123 \
-e TZ="Asia/Shanghai" \
-v /opt/mongodb/data/db:/data/db \
-v /opt/mongodb/data/configdb:/data/configdb \
mongo:8.0.15
```

## 用户、数据库、权限赋予操作

1. 进入容器
```shell
docker exec -it mongodb /bin/bash
```
2. 容器内连接mongodb
```shell
mongosh -u root -p RootPass_123
```

> `docker exec -it mongodb mongosh -u root -p RootPass_123`


### 创建账号

#### 创建普通账号
##### 创建数据库
```shell
use iotgz_db_dm
```
##### 在数据库中创建有权限操作的用户
```shell
db.createUser({
  user: "iot_user",
  pwd: "iot_pass_123",
  roles: [ { role: "readWrite", db: "iotgz_db_dm" } ]
})
```
##### 验证
```shell
db.auth("iot_user", "iot_pass_123")
```

##### 创建一个调试的 collection
```shell
db.createCollection("devices")
```
```shell
db.devices.insertOne({
  deviceId: "sensor_001",
  type: "temperature",
  value: 26.4,
  timestamp: new Date()
})
```
```shell
db.devices.find()
```


#### (补充) 再创建运维账号

- 登录初始化的超级用户

```shell
docker exec -it mongodb mongosh -u root -p RootPass_123 --authenticationDatabase admin
```

- 创建
```shell
use admin 
```
```shell
db.createUser({
  user: "suadmin",
  pwd: "Su_admin_123",
  roles: [
    { role: "userAdminAnyDatabase", db: "admin" },
    { role: "readWriteAnyDatabase", db: "admin" }
  ]
})
```

- 测试登录
```shell
docker exec -it mongodb mongosh -u suadmin -p Su_admin_123 --authenticationDatabase admin
```

--- 

| 角色名                    | 说明                      |
| ---------------------- | ----------------------- |
| `readAnyDatabase`      | 允许读取所有数据库（除 system 数据库） |
| `readWriteAnyDatabase` | 可读写所有数据库                |
| `userAdminAnyDatabase` | 可在任意数据库创建/管理用户          |
| `dbAdminAnyDatabase`   | 可在任意数据库管理结构（如索引、集合）     |


## 一些命令

### 数据库操作

查看当前数据库：

```shell
db
```

查看所有数据库：

```shell
show dbs
```

切换或创建数据库（MongoDB 会在插入数据后自动创建）：

```shell
use iotgz_db_dm
```

查看当前数据库下的集合（相当于表）：

```shell
show collections
```

---

### 用户管理

查看当前数据库下的用户：

```shell
show users
```

创建一个普通读写用户：

```shell
db.createUser({
  user: "iot_user",
  pwd: "iot_pass_123",
  roles: [ { role: "readWrite", db: "iotgz_db_dm" } ]
})
```

修改用户密码：

```shell
db.updateUser("iot_user", {pwd: "iot_pass_456"})
```

删除用户：

```shell
db.dropUser("iot_user")
```

---

### 集合（表）操作

创建集合：

```shell
db.createCollection("device_data")
```

查看所有集合：

```shell
show collections
```

删除集合：

```shell
db.device_data.drop()
```

重命名集合：

```shell
db.device_data.renameCollection("iot_data")
```

---

### 插入数据

插入一条数据：

```shell
db.device_data.insertOne({device_id: "A001", temp: 23.5, ts: new Date()})
```

插入多条数据：

```shell
db.device_data.insertMany([
  {device_id: "A002", temp: 26.1, ts: new Date()},
  {device_id: "A003", temp: 21.7, ts: new Date()}
])
```

---

### 查询数据

查询全部数据：

```shell
db.device_data.find()
```

格式化输出（更好读）：

```shell
db.device_data.find().pretty()
```

按条件查询：

```shell
db.device_data.find({device_id: "A001"})
```

模糊查询（正则表达式）：

```shell
db.device_data.find({device_id: /A.*/})
```

范围查询（大于、小于）：

```shell
db.device_data.find({temp: {$gt: 20, $lt: 25}})
```

只显示部分字段：

```shell
db.device_data.find({}, {device_id: 1, temp: 1, _id: 0})
```

按字段排序（1升序，-1降序）：

```shell
db.device_data.find().sort({temp: -1})
```

分页查询（跳过2条，取2条）：

```shell
db.device_data.find().skip(2).limit(2)
```

统计记录数：

```shell
db.device_data.countDocuments()
```

---

### 更新数据

更新单条数据：

```shell
db.device_data.updateOne(
  {device_id: "A001"},
  {$set: {temp: 25.8}}
)
```

批量更新符合条件的数据：

```shell
db.device_data.updateMany(
  {temp: {$lt: 24}},
  {$set: {status: "low_temp"}}
)
```

替换整个文档：

```shell
db.device_data.replaceOne(
  {device_id: "A002"},
  {device_id: "A002", temp: 29.9, ts: new Date()}
)
```

---

### 删除数据

删除一条数据：

```shell
db.device_data.deleteOne({device_id: "A003"})
```

删除多条数据：

```shell
db.device_data.deleteMany({status: "low_temp"})
```

清空整个集合：

```shell
db.device_data.deleteMany({})
```

---

### 索引管理

创建索引：

```shell
db.device_data.createIndex({device_id: 1})
```

查看索引：

```shell
db.device_data.getIndexes()
```

删除索引：

```shell
db.device_data.dropIndex("device_id_1")
```

---

### 数据库管理

查看数据库统计信息：

```shell
db.stats()
```

删除当前数据库：

```shell
db.dropDatabase()
```

---

### 权限与角色

查看当前连接用户的权限信息：

```shell
db.runCommand({ connectionStatus: 1 })
```

查看系统中定义的所有角色：

```shell
db.system.roles.find().pretty()
```
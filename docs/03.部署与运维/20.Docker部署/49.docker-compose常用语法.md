---
title: docker-compose常用语法
date: 2023-05-13 23:12:11
permalink: /pages/bcf771/
categories:
  - 部署与运维
  - Docker部署
tags:
  - docker
author: 
  name: Mr.Kusch
  link: https://github.com/kuschzzp
---

## Docker Compose 常用配置项详解

### 1. 顶层结构字段

Compose 文件最外层一般包含：

| 字段         | 作用                |
| ---------- | ----------------- |
| `name`     | 项目名称，不写时默认使用目录名   |
| `services` | 多个容器服务的定义（最核心）    |
| `volumes`  | 命名卷定义             |
| `networks` | 自定义网络             |
| `secrets`  | 密钥（如密码文件）         |
| `configs`  | 配置文件（更偏 Swarm 平台） |

示例结构：

```yaml
name: my-app

services:
  ...

volumes:
  ...

networks:
  ...
```


### 2. services

`services` 是 Compose 文件的主体。它定义了每一个容器的行为与特性。

下面逐个介绍常见字段与作用。

#### 2.1 image

```yaml
image: nginx:latest
```

如果服务不需要本地构建，直接用 `image` 即可。


#### 2.2 build

```yaml
build:
  context: ./backend
  dockerfile: Dockerfile
  args:
    ENV: prod
```

作用：

* 从本地目录构建镜像
* 支持传入 build args
* context 决定构建上下文

#### 2.3 container_name

```yaml
container_name: backend
```

注意：如果不写，Compose 会自动生成：`<项目名>_<服务名>_1`。


#### 2.4 restart

常用：`unless-stopped`（推荐）

```yaml
restart: unless-stopped
```

策略说明：

* `no`：默认，不重启
* `always`：不管发生什么都重启（包括你手动 stop）
* `on-failure`：只在退出码不为 0 时重启
* `unless-stopped`：意外退出重启，手动停止不会重启（最常用）

 

#### 2.5 ports

```yaml
ports:
  - "80:80"
```

格式：`宿主机:容器`

 

#### 2.6 environment

两种写法：

数组：

```yaml
environment:
  - TZ=Asia/Shanghai
  - DEBUG=true
```

键值：

```yaml
environment:
  TZ: Asia/Shanghai
  DEBUG: "true"
```

 

#### 2.7 env_file

```yaml
env_file:
  - .env
```

 

#### 2.8 volumes

- 本地目录：

```yaml
volumes:
  - ./nginx/conf.d:/etc/nginx/conf.d
```

- 命名卷：

```yaml
volumes:
  - db_data:/var/lib/mysql
```

#### 2.9 depends_on

```yaml
depends_on:
  - backend
  - redis
```

说明：

* 只控制启动顺序
* 不控制“依赖服务是否健康”
* 若要等待服务可用 → 必须用 healthcheck


#### 2.10 command/entrypoint

```yaml
command: ["npm", "run", "start"]
```

#### 2.11 networks

```yaml
networks:
  - app_net
```

加入同一网络的服务可通过服务名互相访问：

```
http://backend:8080
```



#### 2.12 healthcheck

```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
  interval: 10s
  timeout: 5s
  retries: 3
  start_period: 10s
```

用途：

* 用于判断容器是否可用
* 配合 depends_on，使依赖服务等待 Healthy 状态



#### 2.13 logging

默认 json-file 会无限增长，建议配置滚动策略：

```yaml
logging:
  driver: json-file
  options:
    max-size: "10m"
    max-file: "5"
```



#### 2.14 extra_hosts

```yaml
extra_hosts:
  - "host.docker.internal:host-gateway"
```



### 3. volumes

```yaml
volumes:
  db_data:
  redis_data:
```

命名卷适用于持久化数据库数据。



### 4. networks

```yaml
networks:
  app_net:
    driver: bridge
```

服务加入网络：

```yaml
services:
  web:
    networks:
      - app_net
```

### 5. secrets / configs

常用于 Swarm 或支持的平台。

```yaml
secrets:
  db_password:
    file: ./secrets/db_password.txt
```

### 6. 常用配置模板段


#### 6.1 restart

```yaml
restart: unless-stopped
```


#### 6.2 logging

```yaml
logging:
  driver: json-file
  options:
    max-size: "10m"
    max-file: "5"
```

 

#### 6.3 healthcheck

```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 10s
```

### 7. 完整综合示例

```yaml
# -----------------------------------------
# 整个 Compose 项目的名字（可选）
# 不写时默认使用 compose.yml 所在文件夹的名字
# 建议写，便于多个项目区分
# -----------------------------------------
name: my-fullstack-app


# -----------------------------------------
# services 字段：定义所有要运行的容器服务
# 例如后端服务 backend、前端代理 nginx 等
# -----------------------------------------
services:

  # ============================================================
  # 后端服务 backend
  # ============================================================
  backend:
    # ----------------------------------------------------------
    # build: 指定使用 Dockerfile 构建镜像
    # 这里表示 backend 服务的镜像来源于 ./backend 目录
    # 该目录中需要有 Dockerfile
    # ----------------------------------------------------------
    build: ./backend

    # ----------------------------------------------------------
    # container_name：自定义容器名称
    # 不写的话名字会变成 my-fullstack-app_backend_1
    # ----------------------------------------------------------
    container_name: backend

    # ----------------------------------------------------------
    # restart：重启策略
    # unless-stopped：除非手动停止，否则容器异常退出时自动重启
    # 这是生产环境最常用的策略
    # ----------------------------------------------------------
    restart: unless-stopped

    # ----------------------------------------------------------
    # ports：端口映射（宿主机:容器）
    # 这里表示宿主机 8080 → 容器 8080
    # 即你在浏览器访问 http://localhost:8080 会进到 backend 容器
    # ----------------------------------------------------------
    ports:
      - "8080:8080"

    # ----------------------------------------------------------
    # environment：设置环境变量
    # 这些变量会传递给 Dockerfile ENTRYPOINT 或应用程序
    # ----------------------------------------------------------
    environment:
      TZ: Asia/Shanghai      # 设置容器时区
      APP_ENV: prod          # 自定义变量，应用可用它识别环境

    # ----------------------------------------------------------
    # volumes：数据挂载
    # 左边宿主机目录 → 右边容器内目录
    # 这里将本地 logs/backend 文件夹挂载到容器 /app/logs
    # 方便查看日志、持久化记录
    # ----------------------------------------------------------
    volumes:
      - ./logs/backend:/app/logs

    # ----------------------------------------------------------
    # logging：Docker 日志配置
    # 默认日志无上限会把磁盘写满，所以生产环境一定要配置滚动日志
    #
    # max-size：单个日志文件最大大小
    # max-file：最多保留多少个文件
    # ----------------------------------------------------------
    logging:
      driver: json-file
      options:
        max-size: "10m"   # 每个日志文件最大 10MB
        max-file: "5"     # 最多保留 5 个文件（滚动替换）

    # ----------------------------------------------------------
    # healthcheck：健康检查（后端服务必备）
    #
    # test：健康检查命令
    # interval：检查间隔
    # timeout：单次检查超时时间
    # retries：失败几次后视为 unhealthy
    # start_period：服务启动后等待多久再开始执行检查
    #
    # 后面 nginx 会依赖 backend 的健康状态
    # ----------------------------------------------------------
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s       # 每 10 秒检查一次
      timeout: 5s         # 超过 5 秒认为失败
      retries: 3          # 连续 3 次失败才判定容器 unhealthy
      start_period: 10s   # 启动后等 10 秒再检查（避免刚启动就报错）



  # ============================================================
  # Nginx 服务（静态资源托管、反向代理等）
  # ============================================================
  nginx:
    # ----------------------------------------------------------
    # 直接使用官方镜像，不构建
    # ----------------------------------------------------------
    image: nginx:latest

    container_name: nginx
    restart: unless-stopped

    # ----------------------------------------------------------
    # 将本地端口 80 映射到容器内 80
    # 可以直接用浏览器访问 http://localhost
    # ----------------------------------------------------------
    ports:
      - "80:80"

    # ----------------------------------------------------------
    # 静态资源、配置文件、日志文件挂载
    #
    # faq：
    # - conf.d 存放虚拟主机配置
    # - html 是静态资源
    # - logs 是 Nginx 日志
    # ----------------------------------------------------------
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./nginx/html:/usr/share/nginx/html
      - ./nginx/logs:/var/log/nginx

    # ----------------------------------------------------------
    # depends_on：定义 nginx 依赖 backend
    # condition: service_healthy
    # 表示 nginx 要等到 backend 变成"healthy"才会启动
    # ----------------------------------------------------------
    depends_on:
      backend:
        condition: service_healthy



# -----------------------------------------
# 顶层 volumes：声明命名卷（可选）
# 如果使用 - db_data:/var/lib/mysql 则必须声明
# 此例只是演示写法，当前服务中未用到
# -----------------------------------------
volumes:
  db_data:


# -----------------------------------------
# 顶层 networks：声明自定义网络（可选）
# 默认网络使用 bridge，本案例沿用默认即可
# 可在此扩展自定义网络
# -----------------------------------------
networks:
  default:
    driver: bridge
```


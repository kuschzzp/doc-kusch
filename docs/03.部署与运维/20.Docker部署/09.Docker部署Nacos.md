---
title: Docker部署Nacos
date: 2023-05-19 16:04:01
permalink: /pages/e9bf48/
categories:
  - 部署与运维
  - Docker部署
tags:
  - 
author: 
  name: Mr.Kusch
  link: https://github.com/kuschzzp
---
## Docker 部署 Nacos

> Mysql使用的是在[这里](/pages/1bc205/)部署的。
> SQL文件在这里[SQL语句](https://github.com/alibaba/nacos/blob/master/config/src/main/resources/META-INF/nacos-db.sql)

### 单机部署
- 创建一些文件先
```shell
touch /opt/dockerAllHere/nacos/conf/application.properties && \
touch /opt/dockerAllHere/nacos/conf/nacos-logback.xml
```

- application.properties
**修改好数据库IP**
```
##### nacos 2.2.2 版本的配置文件示例 application.properties 

# spring
server.servlet.contextPath=${SERVER_SERVLET_CONTEXTPATH:/nacos}
server.contextPath=/nacos
server.port=${NACOS_APPLICATION_PORT:8848}
server.tomcat.accesslog.max-days=30
server.tomcat.accesslog.pattern=%h %l %u %t "%r" %s %b %D %{User-Agent}i %{Request-Source}i
server.tomcat.accesslog.enabled=${TOMCAT_ACCESSLOG_ENABLED:false}
server.error.include-message=ALWAYS
# default current work dir
server.tomcat.basedir=file:.
#*************** Config Module Related Configurations ***************#
### Deprecated configuration property, it is recommended to use `spring.sql.init.platform` replaced.
#spring.datasource.platform=${SPRING_DATASOURCE_PLATFORM:}
spring.datasource.platform=mysql

# spring.sql.init.platform=${SPRING_DATASOURCE_PLATFORM:}
spring.sql.init.platform=mysql
nacos.cmdb.dumpTaskInterval=3600
nacos.cmdb.eventTaskInterval=10
nacos.cmdb.labelTaskInterval=300
nacos.cmdb.loadDataAtStart=false
db.num=1
# db.url.0=jdbc:mysql://${MYSQL_SERVICE_HOST}:${MYSQL_SERVICE_PORT:3306}/${MYSQL_SERVICE_DB_NAME}?${MYSQL_SERVICE_DB_PARAM:characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useSSL=false}
# db.user.0=${MYSQL_SERVICE_USER}
# db.password.0=${MYSQL_SERVICE_PASSWORD}

## 这里的ip一定不能使用 127.0.0.1和localhost!!!要填数据库的公网ip，因为docker容器部署nacos，容器内部一定没有mysql!!!
## 建议修改mysql默认端口，建议创建一个 nacos账号，给这个账号授权，只能操作nacos数据库，操作略。没有的话可以暂时用root账号
db.url.0=jdbc:mysql://ip:3306/test_db?characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useSSL=false&serverTimezone=UTC
db.user.0=test
db.password.0=Test@123

#db.pool.config.connectionTestQuery=SELECT * FROM dual
### The auth system to use, currently only 'nacos' and 'ldap' is supported:
nacos.core.auth.system.type=${NACOS_AUTH_SYSTEM_TYPE:nacos}
### worked when nacos.core.auth.system.type=nacos
### The token expiration in seconds:
nacos.core.auth.plugin.nacos.token.expire.seconds=${NACOS_AUTH_TOKEN_EXPIRE_SECONDS:18000}
### The default token:
nacos.core.auth.plugin.nacos.token.secret.key=${NACOS_AUTH_TOKEN:}
### Turn on/off caching of auth information. By turning on this switch, the update of auth information would have a 15 seconds delay.
nacos.core.auth.caching.enabled=${NACOS_AUTH_CACHE_ENABLE:false}
nacos.core.auth.enable.userAgentAuthWhite=${NACOS_AUTH_USER_AGENT_AUTH_WHITE_ENABLE:false}
nacos.core.auth.server.identity.key=${NACOS_AUTH_IDENTITY_KEY:}
nacos.core.auth.server.identity.value=${NACOS_AUTH_IDENTITY_VALUE:}
## spring security config
### turn off security
nacos.security.ignore.urls=${NACOS_SECURITY_IGNORE_URLS:/,/error,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.ico,/console-fe/public/**,/v1/auth/**,/v1/console/health/**,/actuator/**,/v1/console/server/**}
# metrics for elastic search
management.metrics.export.elastic.enabled=false
management.metrics.export.influx.enabled=false
nacos.naming.distro.taskDispatchThreadCount=10
nacos.naming.distro.taskDispatchPeriod=200
nacos.naming.distro.batchSyncKeyCount=1000
nacos.naming.distro.initDataRatio=0.9
nacos.naming.distro.syncRetryDelay=5000
nacos.naming.data.warmup=true
```

- nacos-logback.xml
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration debug="false" scan="true" scanPeriod="1 seconds">
    <contextName>logback</contextName>
    <property name="log.path" value="/home/nacos/logs/logback.log" />
    <appender name="console" class="ch.qos.logback.core.ConsoleAppender">
        <!-- <filter class="com.example.logback.filter.MyFilter" /> -->
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
              <level>ERROR</level>
        </filter>
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} %contextName [%thread] %-5level %logger{36} - %msg%n
            </pattern>
        </encoder>
    </appender>
 
    <appender name="file"
        class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${log.path}</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${log.path}.%d{yyyy-MM-dd}.zip</fileNamePattern>
        </rollingPolicy>
 
        <encoder>
            <pattern>%date %level [%thread] %logger{36} [%file : %line] %msg%n
            </pattern>
        </encoder>
    </appender>
 
    <root level="debug">
        <appender-ref ref="console" />
        <appender-ref ref="file" />
    </root>
 
    <logger name="com.example.logback" level="warn" />
</configuration>
```

- 命令
```shell
docker run -d \
-v /opt/dockerAllHere/nacos/logs:/home/nacos/logs \
-v /opt/dockerAllHere/nacos/conf:/home/nacos/conf \
-e PREFER_HOST_MODE=ip \
-e MODE=standalone \
-e JVM_XMS=128m \
-e JVM_XMX=256m \
-e NACOS_CORE_AUTH_ENABLED=true \
-e NACOS_CORE_AUTH_SERVER_IDENTITY_KEY=keykeykeykeykeykeykeykeykeykeykeykeykeykeykey \
-e NACOS_CORE_AUTH_SERVER_IDENTITY_VALUE=valuevaluevaluevaluevaluevaluevaluevaluevaluevaluevalue \
-e NACOS_CORE_AUTH_PLUGIN_NACOS_TOKEN_SECRET_KEY=TokenTokenTokenTokenTokenTokenTokenTokenTokenTokenTokenToken \
-p 8848:8848 -p 9848:9848 -p 9849:9849 \
--name nacos \
--privileged=true \
nacos/nacos-server:v2.2.2
```

- 访问
**http://ip:8848/nacos/**

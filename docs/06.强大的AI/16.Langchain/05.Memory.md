---
title: Memory
date: 2025-07-14 16:17:17
permalink: /pages/dd68ef/
categories:
  - å¼ºå¤§çš„AI
  - Langchain
tags:
  - LangChain
author: 
  name: Mr.Kusch
  link: https://github.com/kuschzzp
---
### Memory

ä¿å­˜å¯¹è¯å†å²ï¼Œå®ç°ä¸Šä¸‹æ–‡è®°å¿†ï¼ˆå¤šè½®å¯¹è¯ï¼‰ã€‚

### ç¤ºä¾‹

```py
from langchain.chains import ConversationChain
from langchain_community.chat_models import ChatTongyi
from langchain_core.chat_history import InMemoryChatMessageHistory
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.runnables import RunnableConfig
from langchain_core.runnables.history import RunnableWithMessageHistory
from pydantic import SecretStr

# åˆå§‹åŒ–æ¨¡å‹
llm = ChatTongyi(
    model="qwen-turbo",
    api_key=SecretStr("sk-xxxxxxxx")
)

# å®šä¹‰ PromptTemplateï¼šæ³¨å…¥å†å² + ç”¨æˆ·è¾“å…¥
prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€ä¸ªè´´å¿ƒçš„ä¸­æ–‡åŠ©æ‰‹ã€‚"),
    MessagesPlaceholder(variable_name="history"),
    ("human", "{user_input}")
])

# æ„å»ºçº¯æµç¨‹ chain
chain = prompt | llm

# ç”¨äºç®¡ç†ä¸åŒç”¨æˆ·çš„å¯¹è¯å†å²å­˜å‚¨
session_store: dict[str, InMemoryChatMessageHistory] = {}


def get_history(session_id: str) -> InMemoryChatMessageHistory:
    if session_id not in session_store:
        session_store[session_id] = InMemoryChatMessageHistory()
    return session_store[session_id]


# ç”¨ RunnableWithMessageHistory åŒ…è£… chainï¼Œå®ç°å†å²ç®¡ç†
chain_with_memory = RunnableWithMessageHistory(
    runnable=chain,
    get_session_history=get_history,
    input_messages_key="user_input",
    history_messages_key="history"
)

# æ¨¡æ‹Ÿå¤šè½®å¯¹è¯


config: RunnableConfig = {
    "configurable": {"session_id": "user1"}
}

for text in ["æˆ‘å«æé›·", "ä½ è®°å¾—æˆ‘æ˜¯è°å—ï¼Ÿ"]:
    res = chain_with_memory.invoke(
        {"user_input": text},
        config=config
    )
    print("ğŸ¤–", res.content)

```
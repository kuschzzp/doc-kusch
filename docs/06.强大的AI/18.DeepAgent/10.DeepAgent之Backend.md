---
title: DeepAgent之Backend
date: 2025-12-30 17:57:41
permalink: /pages/b08c8d/
categories:
  - 强大的AI
  - DeepAgent
tags:
  - deepAgent
author: 
  name: Mr.Kusch
  link: https://github.com/kuschzzp
---

# DeepAgent Backends

原文地址：[https://docs.langchain.com/oss/python/deepagents/backends](https://docs.langchain.com/oss/python/deepagents/backends)


## Backend 核心作用
为 Deep Agent 提供文件系统工具接口（`ls`, `read_file`, `write_file`, `edit_file`, `glob`, `grep`），不是状态持久化！

```
用户 → Agent → 文件工具 → Backend → 实际存储
                    ↓
              checkpointer（对话历史）
              store（键值数据）
```

## 三大区别总结
| 参数 | 作用 | 存什么 | 示例目录 |
|------|------|--------|----------|
| `backend` | 文件系统工具沙箱 | 文件内容（`/workspace/main.py`） | `./workspace/` |
| `checkpointer` | 对话状态持久化 | `messages` 历史 + 执行状态 | `./checkpoints/` |
| `store` | 键值数据缓存 | `{"user_name": "小明"}` | `./store/` |

## 内置 Backend 类型

### 1. StateBackend（默认，临时存储）
```python
agent = create_deep_agent()  # 默认
# 等价于：
from deepagents.backends import StateBackend
agent = create_deep_agent(backend=lambda rt: StateBackend(rt))
```
- 特点：存于当前线程的 LangGraph 状态，单线程临时
- 最佳场景：scratch pad，中间结果
- 限制：线程结束即丢

### 2. FilesystemBackend（本地磁盘）
```python
from deepagents.backends import FilesystemBackend
agent = create_deep_agent(
    backend=FilesystemBackend(
        root_dir="/absolute/path/to/workspace",  # 必须绝对路径
        virtual_mode=True  # 沙箱模式，防止路径穿越
    )
)
```
- 特点：
  - 读写真实文件
  - `virtual_mode=True`：路径规范化，安全沙箱
  - 支持 ripgrep 加速 `grep`
- 最佳场景：本地项目、CI、持久卷

### 3. StoreBackend（跨线程持久）
```python
from deepagents.backends import StoreBackend
from langgraph.store.memory import InMemoryStore
agent = create_deep_agent(
    backend=lambda rt: StoreBackend(rt),
    store=InMemoryStore()  # 必须提供 store
)
```
- 特点：使用 LangGraph Store，跨线程持久
- 最佳场景：LangSmith Deployment、Redis/Postgres

### 4. CompositeBackend（路由器）
```python
from deepagents.backends import CompositeBackend, StateBackend, FilesystemBackend

backend = lambda rt: CompositeBackend(
    default=StateBackend(rt),  # 默认临时
    routes={
        "/memories/": FilesystemBackend(root_dir="./memories"),  # 持久记忆
        "/docs/": FilesystemBackend(root_dir="./docs"),          # 文档
    }
)
agent = create_deep_agent(backend=backend)
```
- 特点：路径前缀路由不同后端
- 行为：
  ```
  /workspace/plan.md → StateBackend（临时）
  /memories/note.md → FilesystemBackend（持久）
  ```

## 配置方式

```python
# 1. 直接实例
backend=FilesystemBackend(root_dir="./workspace")

# 2. 工厂函数（需要 runtime）
backend=lambda rt: StateBackend(rt)

# 3. 复杂路由
backend=lambda rt: CompositeBackend(...)
```

## 安全特性

### `virtual_mode=True`（FilesystemBackend）
```
真实路径: /Users/kusch/.../workspace/main.py
代理看到: /workspace/main.py（虚拟路径）
防止: ../../etc/passwd 等路径穿越攻击
```

### 策略钩子（Policy Hooks）
```python
class GuardedBackend(FilesystemBackend):
    def __init__(self, deny_prefixes=["/etc/"], **kwargs):
        super().__init__(**kwargs)
        self.deny_prefixes = deny_prefixes
    
    def write(self, file_path: str, content: str) -> WriteResult:
        if any(file_path.startswith(p) for p in self.deny_prefixes):
            return WriteResult(error="禁止写入！")
        return super().write(file_path, content)
```

## 实际使用场景

```python
# 完整生产配置
agent = create_deep_agent(
    model=llm,
    tools=[internet_search, write_file, read_file],
    
    # 对话历史
    checkpointer=AsyncFilesystemSaver("./checkpoints"),
    
    # 文件系统（文件工具）
    backend=lambda rt: CompositeBackend(
        default=StateBackend(rt),  # 临时文件
        routes={
            "/memories/": FilesystemBackend("./memories"),  # 长期记忆
            "/workspace/": FilesystemBackend("./workspace"), # 工作区
        }
    ),
    
    # 键值数据
    store=AsyncFilesystemStore("./store")
)

# Agent 使用：
# ls /workspace/           → 工作区文件列表
# write /memories/note.md  → 持久化笔记
# read /workspace/main.py  → 读取代码
```

## 目录结构示例
```
项目/
├── checkpoints/          # checkpointer（对话历史）
├── store/               # store（键值数据）
├── memories/            # backend /memories/（长期文件）
├── workspace/           # backend /workspace/（临时工作）
└── agent.py
```

## 最佳实践

```
1. 本地开发 → FilesystemBackend("./workspace", virtual_mode=True)
2. 生产部署 → StoreBackend + LangSmith Deployment
3. 混合需求 → CompositeBackend（临时+持久）
4. 始终搭配 checkpointer 实现完整记忆
```

**参考**：
- [Deep Agents Backends](https://docs.langchain.com/oss/python/deepagents/backends)
- [LangGraph Persistence](https://docs.langchain.com/oss/python/langgraph/persistence)
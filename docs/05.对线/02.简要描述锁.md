---
title: 简要描述锁
date: 2024-03-05 13:33:55
permalink: /pages/83560c/
categories:
  - 对线
tags:
  -
author:
  name: Mr.Kusch
  link: https://github.com/kuschzzp
---

## 简要描述Java中的锁

锁是用来控制多个线程访问共享资源的工具，一般来说，一个锁能够防止多个线程同时访问共享资源。主要常见的就是悲观锁和乐观锁。

### 1. 悲观锁

悲观锁总是会认为共享数据在被访问时出现问题，所以每次操作资源都会加上锁，以防止其他线程访问。
悲观锁的实现方式主要有两种：`synchronized` 和 `ReentrantLock`。
对于悲观锁在高并发场景下，性能会有所下降，甚至出现死锁。
悲观锁通常用在写比较多的场景下。

### 2. 乐观锁

乐观锁总是认为共享数据在被访问时不会出现问题，所以每次操作资源都不会加锁，也不需要等待。
乐观锁的实现方式主要有两种：`CAS` 和 `版本号`。
Java的JUC包下的`Atomic`类就是乐观锁CAS的一种实现。
乐观锁写比较少的情况下。
对于乐观锁常见的ABA问题，通常在使用乐观锁时，会配合版本号进行使用。

## 简要描述MySQL数据库中的锁

MySQL中的锁主要分为两种：`表锁` 和 `行锁`。

- 表级锁：是针对非索引字段加的锁，对当前操作的整张表加锁，加锁快，不会出现死锁。但是高并发下效率极低，MyISAM 和 InnoDB
  引擎都支持表级锁。

- 行级锁：针对索引字段加的锁 ，只针对当前操作的行记录进行加锁。但加锁的开销大，加锁慢，会出现死锁。行级锁和存储引擎有关，是在存储引擎层面实现的。

**在编写SQL的UPDATE、DELETE时如果WHERE条件没有命中唯一索引或者索引失效，那就会对所有行加锁。**

### InnoDB的行级锁

- 记录锁：锁单个行
- 间隙锁：锁一个范围，不包括本身
- 临键锁：记录锁+间隙锁，包含记录本身，主要是为了解决幻读问题。

> InnoDB 的可重复读下，行锁默认使用的是临键锁。
> 但是，如果操作的索引是唯一索引或主键，InnoDB 会对临键锁进行优化，将其降级为记录锁，即仅锁住索引本身，而不是范围。





















